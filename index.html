<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sudoku-Mathelis</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sudoku-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px;
      background: linear-gradient(45deg, #8b5cf6, #a855f7); border: 3px solid #8b5cf6; }
    .sudoku-cell { width: 45px; height: 45px; border: none; text-align: center;
      font-size: 18px; font-weight: bold; background-color: white; }
    .sudoku-cell:focus { outline: 3px solid #ec4899; background: linear-gradient(135deg, #fce7f3, #f9a8d4);
      transform: scale(1.05); transition: all 0.2s ease; }
    .given-number { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #fff; font-weight: 900;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3); }
    .user-input { background: linear-gradient(135deg, #e0f2fe, #b3e5fc); color: #0d47a1; font-weight: bold; }
    .sudoku-cell:nth-child(3n):not(:nth-child(9n)) { border-right: 2px solid #8b5cf6; }
    .sudoku-cell:nth-child(n+19):nth-child(-n+27),
    .sudoku-cell:nth-child(n+46):nth-child(-n+54) { border-bottom: 2px solid #8b5cf6; }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-purple-50 to-indigo-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-purple-800 mb-2">Sudoku-Mathelis</h1>
      <p class="text-lg text-gray-600">Mathletica: ƒê·ªë vui kh√¥ng th∆∞·ªüng #1</p>
    </div>

    <!-- Game Setup Screen -->
    <div id="setupScreen" class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-semibold text-center mb-6 text-gray-800">B·∫Øt ƒë·∫ßu tr√≤ ch∆°i</h2>
      <div class="mb-4">
        <label for="playerName" class="block text-sm font-medium text-gray-700 mb-2">Nh·∫≠p t√™n c·ªßa b·∫°n:</label>
        <input type="text" id="playerName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="T√™n ng∆∞·ªùi ch∆°i">
      </div>
      <button onclick="startGame()" 
        class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white py-2 px-4 rounded-md hover:from-pink-600 hover:to-purple-700 transition duration-200 font-semibold mb-3">
        B·∫Øt ƒë·∫ßu
      </button>
      <button onclick="openLeaderboardModal()" 
        class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-2 px-4 rounded-md hover:from-yellow-500 hover:to-orange-600 transition duration-200 font-semibold">
        üèÜ Xem b·∫£ng x·∫øp h·∫°ng
      </button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden">
      <div class="max-w-4xl mx-auto">
        <!-- Game Info -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
          <div class="flex justify-between items-center">
            <div>
              <span class="text-lg font-semibold text-gray-700">Ng∆∞·ªùi ch∆°i: </span>
              <span id="displayName" class="text-lg font-bold text-purple-600"></span>
            </div>
            <div>
              <span class="text-lg font-semibold text-gray-700">Th·ªùi gian: </span>
              <span id="timer" class="text-lg font-bold text-orange-500">00:00</span>
            </div>
          </div>
        </div>
        <!-- Sudoku Grid -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div class="sudoku-grid mx-auto w-fit"></div>
        </div>
        <!-- Check Button -->
        <div class="text-center">
          <button id="checkButton" onclick="checkSolution()" class="hidden bg-gradient-to-r from-green-400 to-emerald-500 text-white py-3 px-8 rounded-md hover:from-green-500 hover:to-emerald-600 transition duration-200 font-semibold text-lg shadow-lg">
            Ki·ªÉm tra
          </button>
        </div>
      </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 max-w-md mx-4">
        <div class="text-center">
          <div class="text-6xl mb-4">üéâ</div>
          <h2 class="text-2xl font-bold text-emerald-600 mb-4">Ch√∫c m·ª´ng <span id="winnerName"></span>!</h2>
          <p class="text-gray-700 mb-2">B·∫°n ƒë√£ ho√†n th√†nh Sudoku!</p>
          <p class="text-lg font-semibold text-purple-600 mb-6">
            Th·ªùi gian: <span id="finalTime"></span>
          </p>
          <!-- Leaderboard -->
          <div id="leaderboard" class="bg-gray-100 p-4 rounded-md mb-6 text-left">
            <h3 class="font-bold text-purple-700 mb-2">üèÜ B·∫£ng x·∫øp h·∫°ng</h3>
          </div>
          <button onclick="resetGame()" class="bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 px-6 rounded-md hover:from-purple-600 hover:to-pink-600 transition duration-200">
            Ch∆°i l·∫°i
          </button>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 max-w-md mx-4">
        <div class="text-center">
          <div class="text-6xl mb-4">‚ùå</div>
          <h2 class="text-2xl font-bold text-red-600 mb-4">Ch∆∞a ƒë√∫ng!</h2>
          <p class="text-gray-700 mb-6">Vui l√≤ng ki·ªÉm tra l·∫°i v√† th·ª≠ l·∫°i.</p>
          <button onclick="closeErrorModal()" class="bg-gradient-to-r from-red-400 to-pink-500 text-white py-2 px-6 rounded-md hover:from-red-500 hover:to-pink-600 transition duration-200">
            Th·ª≠ l·∫°i
          </button>
        </div>
      </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboardModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-8 max-w-md mx-4 w-full">
        <div class="text-center">
          <h2 class="text-2xl font-bold text-purple-700 mb-4">üèÜ B·∫£ng x·∫øp h·∫°ng</h2>
          <div id="leaderboardList" class="bg-gray-100 p-4 rounded-md mb-6 text-left"></div>
          <button onclick="closeLeaderboardModal()" 
            class="bg-gradient-to-r from-purple-500 to-pink-500 text-white py-2 px-6 rounded-md hover:from-purple-600 hover:to-pink-600 transition duration-200">
            ƒê√≥ng
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const puzzle = [
      [1, 3, 9, 4, 8, 7, 0, 0, 0],
      [0, 0, 0, 1, 0, 0, 0, 9, 3],
      [0, 0, 0, 9, 0, 0, 0, 0, 0],
      [0, 7, 4, 0, 0, 9, 0, 1, 0],
      [0, 0, 6, 0, 0, 0, 9, 0, 0],
      [2, 9, 0, 5, 4, 0, 3, 0, 0],
      [4, 0, 8, 0, 0, 0, 5, 7, 0],
      [0, 6, 5, 8, 0, 4, 0, 0, 0],
      [0, 0, 0, 0, 5, 1, 4, 0, 0]
    ];
    const solution = [
      [1, 3, 9, 4, 8, 7, 6, 2, 5],
      [6, 4, 7, 1, 2, 5, 8, 9, 3],
      [8, 5, 2, 9, 3, 6, 7, 4, 1],
      [5, 7, 4, 3, 6, 9, 2, 1, 8],
      [3, 8, 6, 7, 1, 2, 9, 5, 4],
      [2, 9, 1, 5, 4, 8, 3, 6, 7],
      [4, 1, 8, 2, 9, 3, 5, 7, 6],
      [9, 6, 5, 8, 7, 4, 1, 3, 2],
      [7, 2, 3, 6, 5, 1, 4, 8, 9]
    ];
    let startTime, timerInterval, cells = [];
    function startGame() {
      const playerName = document.getElementById('playerName').value.trim();
      if (!playerName) { alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!'); return; }
      document.getElementById('displayName').textContent = playerName;
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('gameScreen').classList.remove('hidden');
      createGrid(); startTimer();
    }
    function createGrid() {
      const grid = document.querySelector('.sudoku-grid'); grid.innerHTML = ''; cells = [];
      for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) {
        const cell = document.createElement('input');
        cell.type = 'text'; cell.className = 'sudoku-cell'; cell.maxLength = 1;
        if (puzzle[r][c] !== 0) { cell.value = puzzle[r][c]; cell.classList.add('given-number'); cell.readOnly = true; }
        else { cell.classList.add('user-input'); cell.addEventListener('input', handleInput); cell.addEventListener('input', checkIfComplete); }
        cell.dataset.row = r; cell.dataset.col = c; grid.appendChild(cell); cells.push(cell);
      }
    }
    function handleInput(e) { if (!/^[1-9]$/.test(e.target.value)) e.target.value = ''; }
    function checkIfComplete() {
      const inputs = cells.filter(c => c.classList.contains('user-input'));
      document.getElementById('checkButton').classList.toggle('hidden', !inputs.every(c => c.value !== ''));
    }
    function startTimer() { startTime = Date.now(); timerInterval = setInterval(updateTimer, 1000); }
    function updateTimer() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(elapsed / 60), s = elapsed % 60;
      document.getElementById('timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function checkSolution() {
      let ok = true;
      for (let r = 0; r < 9; r++) for (let c = 0; c < 9; c++) {
        const idx = r*9+c;
        if (parseInt(cells[idx].value) !== solution[r][c]) { ok = false; break; }
      }
      if (ok) {
        clearInterval(timerInterval);
        const finalTime = document.getElementById('timer').textContent;
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const name = document.getElementById('displayName').textContent;
        document.getElementById('finalTime').textContent = finalTime;
        document.getElementById('winnerName').textContent = name;
        document.getElementById('successModal').classList.remove('hidden');
        if (window.saveScore) window.saveScore(name, finalTime, elapsed);
      } else document.getElementById('errorModal').classList.remove('hidden');
    }
    function closeErrorModal() { document.getElementById('errorModal').classList.add('hidden'); }
    function resetGame() {
      document.getElementById('successModal').classList.add('hidden');
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById('setupScreen').classList.remove('hidden');
      document.getElementById('playerName').value = '';
      document.getElementById('checkButton').classList.add('hidden');
      clearInterval(timerInterval);
    }
    function openLeaderboardModal() {
      document.getElementById('leaderboardModal').classList.remove('hidden');
      if (window.loadLeaderboard) window.loadLeaderboard(true);
    }
    function closeLeaderboardModal() {
      document.getElementById('leaderboardModal').classList.add('hidden');
    }
  </script>

  <!-- Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDyC9Ma9j5NX_xOnQLn83kiT9juDCg5BmM",
      authDomain: "sudoku-9b958.firebaseapp.com",
      projectId: "sudoku-9b958",
      storageBucket: "sudoku-9b958.firebasestorage.app",
      messagingSenderId: "364025578641",
      appId: "1:364025578641:web:2d971cd32213865c56eb30",
      measurementId: "G-GRH5WMKQBV"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function saveScore(name, finalTimeStr, elapsedSeconds) {
      try {
        await addDoc(collection(db, "scores"), {
          name, timeDisplay: finalTimeStr, timeSeconds: elapsedSeconds, createdAt: new Date()
        });
        console.log("‚úÖ L∆∞u k·∫øt qu·∫£ th√†nh c√¥ng!");
        loadLeaderboard();
      } catch (e) { console.error("‚ùå L·ªói khi l∆∞u:", e); }
    }
    async function loadLeaderboard(forModal=false) {
      const q = query(collection(db, "scores"), orderBy("timeSeconds", "asc"), limit(5));
      const qs = await getDocs(q);
      const container = forModal ? document.getElementById("leaderboardList") : document.getElementById("leaderboard");
      container.innerHTML = "<h3 class='font-bold text-purple-700 mb-2'>üèÜ B·∫£ng x·∫øp h·∫°ng</h3>";
      qs.forEach(doc => {
        const d = doc.data();
        const p = document.createElement("p");
        p.textContent = `${d.name} - ${d.timeDisplay}`;
        container.appendChild(p);
      });
    }
    window.saveScore = saveScore;
    window.loadLeaderboard = loadLeaderboard;
  </script>
</body>
</html>
